quarto::quarto_render()
library(tidyverse)
library(ggplot2)
library(gridExtra)
library(dplyr)
weather <- read_csv("https://mac-stat.github.io/data/sfo_weather.csv")
# Compute max day for each month for the vertical lines
month_starts <- weather %>%
group_by(Month) %>%
summarize(max_day = max(dateInYear)) %>%
slice(1:11)
# Compute midpoints for each month for labeling
month_midpoints <- weather %>%
group_by(Month) %>%
summarize(mid_day = (min(dateInYear) + max(dateInYear)) / 2) %>%
ungroup()
# Identify days where the RecordHigh and HiYear match the 2011 high temperature and year
weather$record_high_day <- (weather$High == weather$RecordHigh) & (weather$HiYear == 2011)
# Filter the data for those specific days
record_high_days <- weather %>%
filter(record_high_day == TRUE)
# Create a more staggered Y position for labels to avoid overlap
record_high_days <- record_high_days %>%
mutate(y_label_pos = ifelse(row_number() %% 2 == 0, High + 10, High + 2))  # Increase stagger distance
# Temperature plot with the correct record high labels and vertical lines
temp_plot <- ggplot(weather) +
geom_linerange(aes(x = dateInYear, ymin = RecordLow, ymax = RecordHigh), color = "#D3CEC4") +
geom_linerange(aes(x = dateInYear, ymin = NormalLow, ymax = NormalHigh), color = "#C8B8BA") +
geom_linerange(aes(x = dateInYear, ymin = Low, ymax = High), color = "#A90248") +
geom_vline(xintercept = month_starts$max_day, linetype = "dashed", color = "gray70", size = 0.1) +
# Add horizontal labels for record highs with temperatures, reduce size, adjust position
geom_text(aes(x = dateInYear, y = y_label_pos, label = paste0("Record High: ", High, "°F")),
data = record_high_days, vjust = -1, hjust = 0.5, color = "black", size = 1.8) +  # Smaller size, horizontal labels
scale_x_continuous(breaks = month_midpoints$mid_day, labels = month.abb) +  # X-axis labels on the top graph
theme_classic() +
labs(title = "SFO Weather in 2011", x = NULL, y = "Temperature (°F)") +
theme(plot.title = element_text(hjust = 0.5),
plot.margin = margin(t = 10, b = 30))  # More space on bottom for better fit
# Precipitation plot with vertical lines aligned to the temperature plot
monthly_precip <- weather %>%
group_by(Month) %>%
summarize(dateInYear = max(dateInYear),
CulmPrec = max(CulmPrec),
Precip = sum(Precip))
precip_plot <- ggplot(weather, aes(x = dateInYear)) +
geom_ribbon(aes(ymin = 0, ymax = CulmPrec), fill = "#ebeae2", alpha = 0.5) +
geom_line(aes(y = CulmPrec), color = "#32a3d8", size = 1) +
geom_point(aes(y = CulmPrec), data = weather %>% filter(RecordP == TRUE), shape = 25, color = "black", fill = "black", size = 2.5) +
geom_text(aes(y = CulmPrec, label = round(Precip, 2)), data = monthly_precip, vjust = -2, hjust = 0.5, size = 3.5, color = "black") +
# Add vertical lines in precipitation plot to match temperature plot
geom_vline(xintercept = month_starts$max_day, linetype = "dashed", color = "gray70", size = 0.1) +
scale_x_continuous(breaks = month_midpoints$mid_day, labels = NULL) +  # Remove x-axis labels here
theme_classic() +
labs(x=NULL, y = "Precipitation (inches)") +
theme(plot.margin = margin(t = 30, b = 10))  # Adjust margins to prevent plot cut-off
# Combine the plots into one image
combined_plot <- grid.arrange(temp_plot, precip_plot, nrow = 2, heights = c(2, 1))  # Adjust height ratios
# Compute max day for each month for the vertical lines
month_starts <- weather %>%
group_by(Month) %>%
summarize(max_day = max(dateInYear)) %>%
slice(1:11)
# Compute midpoints for each month for labeling
month_midpoints <- weather %>%
group_by(Month) %>%
summarize(mid_day = (min(dateInYear) + max(dateInYear)) / 2) %>%
ungroup()
# Identify days where the RecordHigh and HiYear match the 2011 high temperature and year
weather$record_high_day <- (weather$High == weather$RecordHigh) & (weather$HiYear == 2011)
# Filter the data for those specific days
record_high_days <- weather %>%
filter(record_high_day == TRUE)
# Create a more staggered Y position for labels to avoid overlap
record_high_days <- record_high_days %>%
mutate(y_label_pos = ifelse(row_number() %% 2 == 0, High + 10, High + 2))  # Increase stagger distance
# Temperature plot with the correct record high labels and vertical lines
temp_plot <- ggplot(weather) +
geom_linerange(aes(x = dateInYear, ymin = RecordLow, ymax = RecordHigh, color = "Record Temperatures")) +
geom_linerange(aes(x = dateInYear, ymin = NormalLow, ymax = NormalHigh, color = "Normal Temperatures")) +
geom_linerange(aes(x = dateInYear, ymin = Low, ymax = High, color = "2011 Temperatures")) +
geom_vline(xintercept = month_starts$max_day, linetype = "dashed", color = "gray70", size = 0.1) +
geom_text(aes(x = dateInYear, y = y_label_pos, label = paste0("Record High: ", High, "°F")),
data = record_high_days, vjust = -1, hjust = 0.5, color = "black", size = 1.8) +  # Smaller size, horizontal labels
scale_x_continuous(breaks = month_midpoints$mid_day, labels = month.abb) +  # X-axis labels on the top graph
theme_classic() +
labs(title = "SFO Weather in 2011", x = NULL, y = "Temperature (°F)") +
theme(plot.title = element_text(hjust = 0.5),
plot.margin = margin(t = 10, b = 30)) +  # More space on bottom for better fit
scale_color_manual(values = c("Record Temperatures" = "#D3CEC4",
"Normal Temperatures" = "#C8B8BA",
"2011 Temperatures" = "#A90248"),
name = "Temperature Types")
# Precipitation plot with vertical lines aligned to the temperature plot
monthly_precip <- weather %>%
group_by(Month) %>%
summarize(dateInYear = max(dateInYear),
CulmPrec = max(CulmPrec),
Precip = sum(Precip))
precip_plot <- ggplot(weather, aes(x = dateInYear)) +
geom_ribbon(aes(ymin = 0, ymax = CulmPrec, fill = "Precipitation"), alpha = 0.5) +
geom_line(aes(y = CulmPrec), color = "#32a3d8", size = 1) +
geom_point(aes(y = CulmPrec), data = weather %>% filter(RecordP == TRUE), shape = 25, color = "black", fill = "black", size = 2.5) +
geom_text(aes(y = CulmPrec, label = round(Precip, 2)), data = monthly_precip, vjust = -2, hjust = 0.5, size = 3.5, color = "black") +
geom_vline(xintercept = month_starts$max_day, linetype = "dashed", color = "gray70", size = 0.1) +
scale_x_continuous(breaks = month_midpoints$mid_day, labels = NULL) +  # Remove x-axis labels here
theme_classic() +
labs(x=NULL, y = "Precipitation (inches)") +
theme(plot.margin = margin(t = 30, b = 10)) +  # Adjust margins to prevent plot cut-off
scale_fill_manual(values = c("Precipitation" = "#ebeae2"),
name = "Layer")
# Combine the plots into one image
combined_plot <- grid.arrange(temp_plot, precip_plot, nrow = 2, heights = c(2, 1))  # Adjust height ratios
# Temperature plot with the correct record high labels and vertical lines
temp_plot <- ggplot(weather) +
geom_linerange(aes(x = dateInYear, ymin = RecordLow, ymax = RecordHigh, color = "Record Temperatures")) +
geom_linerange(aes(x = dateInYear, ymin = NormalLow, ymax = NormalHigh, color = "Normal Temperatures")) +
geom_linerange(aes(x = dateInYear, ymin = Low, ymax = High, color = "2011 Temperatures")) +
geom_vline(xintercept = month_starts$max_day, linetype = "dashed", color = "gray70", size = 0.1) +
geom_text(aes(x = dateInYear, y = y_label_pos, label = paste0("Record High: ", High, "°F")),
data = record_high_days, vjust = -1, hjust = 0.5, color = "black", size = 1.8) +
scale_x_continuous(breaks = month_midpoints$mid_day, labels = month.abb) +
theme_classic() +
labs(title = "SFO Weather in 2011", x = NULL, y = "Temperature (°F)") +
theme(plot.title = element_text(hjust = 0.5),
plot.margin = margin(t = 10, b = 30)) +
scale_color_manual(values = c("Record Temperatures" = "#D3CEC4",
"Normal Temperatures" = "#C8B8BA",
"2011 Temperatures" = "#A90248"),
name = "Temperature Types") +
guides(color = guide_legend(override.aes = list(shape = 15)))  # Shape 15 is a filled square
# Precipitation plot with vertical lines aligned to the temperature plot
precip_plot <- ggplot(weather, aes(x = dateInYear)) +
geom_ribbon(aes(ymin = 0, ymax = CulmPrec, fill = "Precipitation"), alpha = 0.5) +
geom_line(aes(y = CulmPrec), color = "#32a3d8", size = 1) +
geom_point(aes(y = CulmPrec), data = weather %>% filter(RecordP == TRUE), shape = 25, color = "black", fill = "black", size = 2.5) +
geom_text(aes(y = CulmPrec, label = round(Precip, 2)), data = monthly_precip, vjust = -2, hjust = 0.5, size = 3.5, color = "black") +
geom_vline(xintercept = month_starts$max_day, linetype = "dashed", color = "gray70", size = 0.1) +
scale_x_continuous(breaks = month_midpoints$mid_day, labels = NULL) +
theme_classic() +
labs(x=NULL, y = "Precipitation (inches)") +
theme(plot.margin = margin(t = 30, b = 10)) +
scale_fill_manual(values = c("Precipitation" = "#ebeae2"),
name = "Layer") +
guides(fill = guide_legend(override.aes = list(shape = 15)))  # Apply square shape to fill legend
# Combine the plots into one image
combined_plot <- grid.arrange(temp_plot, precip_plot, nrow = 2, heights = c(2, 1))
# Compute max day for each month for the vertical lines
month_starts <- weather %>%
group_by(Month) %>%
summarize(max_day = max(dateInYear)) %>%
slice(1:11)
# Compute midpoints for each month for labeling
month_midpoints <- weather %>%
group_by(Month) %>%
summarize(mid_day = (min(dateInYear) + max(dateInYear)) / 2) %>%
ungroup()
# Identify days where the RecordHigh and HiYear match the 2011 high temperature and year
weather$record_high_day <- (weather$High == weather$RecordHigh) & (weather$HiYear == 2011)
# Filter the data for those specific days
record_high_days <- weather %>%
filter(record_high_day == TRUE)
# Create a more staggered Y position for labels to avoid overlap
record_high_days <- record_high_days %>%
mutate(y_label_pos = ifelse(row_number() %% 2 == 0, High + 10, High + 2))  # Increase stagger distance
# Temperature plot with the correct record high labels and vertical lines
temp_plot <- ggplot(weather) +
geom_linerange(aes(x = dateInYear, ymin = RecordLow, ymax = RecordHigh, color = "Record Temperatures")) +
geom_linerange(aes(x = dateInYear, ymin = NormalLow, ymax = NormalHigh, color = "Normal Temperatures")) +
geom_linerange(aes(x = dateInYear, ymin = Low, ymax = High, color = "2011 Temperatures")) +
geom_vline(xintercept = month_starts$max_day, linetype = "dashed", color = "gray70", size = 0.1) +
geom_text(aes(x = dateInYear, y = y_label_pos, label = paste0("Record High: ", High, "°F")),
data = record_high_days, vjust = -1, hjust = 0.5, color = "black", size = 1.8) +  # Smaller size, horizontal labels
scale_x_continuous(breaks = month_midpoints$mid_day, labels = month.abb) +  # X-axis labels on the top graph
theme_classic() +
labs(title = "SFO Weather in 2011", x = NULL, y = "Temperature (°F)") +
theme(plot.title = element_text(hjust = 0.5),
plot.margin = margin(t = 10, b = 30)) +  # More space on bottom for better fit
scale_color_manual(values = c("Record Temperatures" = "#D3CEC4",
"Normal Temperatures" = "#C8B8BA",
"2011 Temperatures" = "#A90248"),
name = "Temperature Types")
# Precipitation plot with vertical lines aligned to the temperature plot
monthly_precip <- weather %>%
group_by(Month) %>%
summarize(dateInYear = max(dateInYear),
CulmPrec = max(CulmPrec),
Precip = sum(Precip))
precip_plot <- ggplot(weather, aes(x = dateInYear)) +
geom_ribbon(aes(ymin = 0, ymax = CulmPrec, fill = "Precipitation"), alpha = 0.5) +
geom_line(aes(y = CulmPrec), color = "#32a3d8", size = 1) +
geom_point(aes(y = CulmPrec), data = weather %>% filter(RecordP == TRUE), shape = 25, color = "black", fill = "black", size = 2.5) +
geom_text(aes(y = CulmPrec, label = round(Precip, 2)), data = monthly_precip, vjust = -2, hjust = 0.5, size = 3.5, color = "black") +
geom_vline(xintercept = month_starts$max_day, linetype = "dashed", color = "gray70", size = 0.1) +
scale_x_continuous(breaks = month_midpoints$mid_day, labels = NULL) +  # Remove x-axis labels here
theme_classic() +
labs(x=NULL, y = "Precipitation (inches)") +
theme(plot.margin = margin(t = 30, b = 10)) +  # Adjust margins to prevent plot cut-off
scale_fill_manual(values = c("Precipitation" = "#ebeae2"),
name = "Layer")
# Combine the plots into one image
combined_plot <- grid.arrange(temp_plot, precip_plot, nrow = 2, heights = c(2, 1))  # Adjust height ratios
# Compute max day for each month for the vertical lines
month_starts <- weather %>%
group_by(Month) %>%
summarize(max_day = max(dateInYear)) %>%
slice(1:11)
# Compute midpoints for each month for labeling
month_midpoints <- weather %>%
group_by(Month) %>%
summarize(mid_day = (min(dateInYear) + max(dateInYear)) / 2) %>%
ungroup()
# Identify days where the RecordHigh and HiYear match the 2011 high temperature and year
weather$record_high_day <- (weather$High == weather$RecordHigh) & (weather$HiYear == 2011)
# Filter the data for those specific days
record_high_days <- weather %>%
filter(record_high_day == TRUE)
# Create a more staggered Y position for labels to avoid overlap
record_high_days <- record_high_days %>%
mutate(y_label_pos = ifelse(row_number() %% 2 == 0, High + 10, High + 2))  # Increase stagger distance
# Temperature plot with the correct record high labels and vertical lines
temp_plot <- ggplot(weather) +
geom_linerange(aes(x = dateInYear, ymin = RecordLow, ymax = RecordHigh, color = "Record Temperatures")) +
geom_linerange(aes(x = dateInYear, ymin = NormalLow, ymax = NormalHigh, color = "Normal Temperatures")) +
geom_linerange(aes(x = dateInYear, ymin = Low, ymax = High, color = "2011 Temperatures")) +
geom_vline(xintercept = month_starts$max_day, linetype = "dashed", color = "gray70", size = 0.1) +
geom_text(aes(x = dateInYear, y = y_label_pos, label = paste0("Record High: ", High, "°F")),
data = record_high_days, vjust = -1, hjust = 0.5, color = "black", size = 1.8) +  # Smaller size, horizontal labels
scale_x_continuous(breaks = month_midpoints$mid_day, labels = month.abb) +  # X-axis labels on the top graph
theme_classic() +
labs(title = "SFO Weather in 2011", x = NULL, y = "Temperature (°F)") +
theme(plot.title = element_text(hjust = 0.5),
plot.margin = margin(t = 10, b = 30)) +  # More space on bottom for better fit
scale_color_manual(values = c("Record Temperatures" = "#D3CEC4",
"Normal Temperatures" = "#C8B8BA",
"2011 Temperatures" = "#A90248"),
name = "Temperature Types")
# Precipitation plot with vertical lines aligned to the temperature plot
monthly_precip <- weather %>%
group_by(Month) %>%
summarize(dateInYear = max(dateInYear),
CulmPrec = max(CulmPrec),
Precip = sum(Precip))
precip_plot <- ggplot(weather, aes(x = dateInYear)) +
geom_ribbon(aes(ymin = 0, ymax = CulmPrec, fill = "Precipitation"), alpha = 0.5) +
geom_line(aes(y = CulmPrec), color = "#32a3d8", size = 1) +
geom_point(aes(y = CulmPrec), data = weather %>% filter(RecordP == TRUE), shape = 25, color = "black", fill = "black", size = 2.5) +
geom_text(aes(y = CulmPrec, label = round(Precip, 2)), data = monthly_precip, vjust = -2, hjust = 0.5, size = 3.5, color = "black") +
geom_vline(xintercept = month_starts$max_day, linetype = "dashed", color = "gray70", size = 0.1) +
scale_x_continuous(breaks = month_midpoints$mid_day, labels = NULL) +  # Remove x-axis labels here
theme_classic() +
labs(x=NULL, y = "Precipitation (inches)") +
theme(plot.margin = margin(t = 30, b = 10)) +  # Adjust margins to prevent plot cut-off
scale_fill_manual(values = c("Precipitation" = "#ebeae2"),
name = "Layer")
# Combine the plots into one image
combined_plot <- grid.arrange(temp_plot, precip_plot, nrow = 2, heights = c(2, 1))  # Adjust height ratios
